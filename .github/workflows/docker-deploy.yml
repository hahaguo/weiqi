name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.DEPLOYMENT_URL }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH || '/opt/weiqi' }}

            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main

            echo "ğŸ³ æ‹‰å–æœ€æ–° Docker é•œåƒ..."
            docker-compose pull

            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            docker-compose down
            docker-compose up -d

            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10

            echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose ps

            echo "âœ… å¥åº·æ£€æŸ¥..."
            curl -f http://localhost:8080/health || exit 1

            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -af --filter "until=168h"

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      - name: éƒ¨ç½²é€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ å›´æ£‹æ•™å­¦æ¸¸æˆéƒ¨ç½² ${{ job.status }}
            ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}
            ç‰ˆæœ¬: ${{ github.ref_name }}
            æäº¤: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
